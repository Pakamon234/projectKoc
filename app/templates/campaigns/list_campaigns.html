{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">Danh m·ª•c chi·∫øn d·ªãch</h2>
  <div class="row">
    <!-- B·ªô l·ªçc tr√°i -->
    <div class="col-md-3">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title">L·ªçc theo tr·∫°ng th√°i</h5>

          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="1" id="check_1" checked>
            <label class="form-check-label text-warning" for="check_1">ƒê√£ x√°c nh·∫≠n</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="2" id="check_2" checked>
            <label class="form-check-label text-success" for="check_2">Ho·∫°t ƒë·ªông</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="3" id="check_3" checked>
            <label class="form-check-label text-primary" for="check_3">Th√†nh c√¥ng</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Danh s√°ch chi·∫øn d·ªãch -->
    <div class="col-md-9">
      <!-- T√¨m ki·∫øm & s·∫Øp x·∫øp -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="search-input" class="form-control me-3" placeholder="üîç T√¨m theo ti√™u ƒë·ªÅ ho·∫∑c m√¥ t·∫£..."
          style="max-width: 400px;">
        <select id="sort-select" class="form-select w-auto">
          <option value="desc">M·ªõi nh·∫•t tr∆∞·ªõc</option>
          <option value="asc">C≈© nh·∫•t tr∆∞·ªõc</option>
        </select>
      </div>

      <!-- Th√¥ng b√°o -->
      <div id="no-result" class="alert alert-info d-none text-center">
        <i class="fas fa-info-circle me-1"></i> Kh√¥ng t√¨m th·∫•y chi·∫øn d·ªãch ph√π h·ª£p.
      </div>

      <!-- Danh s√°ch + ph√¢n trang -->
      <div class="row row-cols-1 row-cols-md-2 g-4" id="campaign-list">
        {% for c in campaigns %}
        <div class="col campaign-item" data-status="{{ c.status }}" data-title="{{ c.title | lower }}"
          data-description="{{ c.description | lower }}" data-date="{{ c.startDate }}">
          <div class="card h-100 shadow-sm transition">
            <div class="card-body">
              <h5 class="card-title">{{ c.title }}</h5>
              <p class="card-text text-muted">{{ c.description[:100] }}{% if c.description|length > 100 %}...{% endif %}
              </p>
              <p class="card-text"><i class="fas fa-calendar-alt me-1"></i> T·ª´ {{ c.startDate }} ƒë·∫øn {{ c.endDate }}</p>

              <p class="card-text">
                {% if c.status == 1 %}
                <span class="badge bg-warning text-dark">ƒê√£ x√°c nh·∫≠n</span>
                {% elif c.status == 2 %}
                <span class="badge bg-success">Ho·∫°t ƒë·ªông</span>
                {% elif c.status == 3 %}
                <span class="badge bg-primary">Th√†nh c√¥ng</span>
                {% endif %}
              </p>

              <!-- Duy·ªát qua c√°c chi·∫øn d·ªãch -->
              <a href="#" class="btn btn-outline-primary mt-2" data-bs-toggle="modal"
                data-bs-target="#campaignDetailModal{{ c.id }}">Xem chi ti·∫øt</a>
              <!-- N√∫t ƒêƒÉng k√Ω ch·ªâ d√†nh cho KOC (roleId = 2) v√† n·∫øu trong kho·∫£ng th·ªùi gian ƒëƒÉng k√Ω -->
              <a href="#" class="btn btn-outline-success mt-2" data-bs-toggle="modal"
                data-bs-target="#registerCampaignModal{{ c.id }}">ƒêƒÉng k√Ω</a>

              <!-- Modal chi ti·∫øt chi·∫øn d·ªãch -->
              <div class="modal fade" id="campaignDetailModal{{ c.id }}" tabindex="-1"
                aria-labelledby="campaignDetailModalLabel{{ c.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="campaignDetailModalLabel{{ c.id }}">Chi ti·∫øt chi·∫øn d·ªãch: {{ c.title }}
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- N·ªôi dung chi ti·∫øt chi·∫øn d·ªãch -->
                      <h5>Ti√™u ƒë·ªÅ:</h5>
                      <p>{{ c.title }}</p>

                      <h5>Doanh nghi·ªáp:</h5>
                      <p>{{ c.business.name if c.business else 'Ch∆∞a c√≥ doanh nghi·ªáp' }}</p>

                      <h5>Lo·∫°i chi·∫øn d·ªãch:</h5>
                      <p>{{ c.category.name }}</p>

                      <h5>M√¥ t·∫£:</h5>
                      <p><strong></strong><br> {{ c.description | replace('\n', '<br>') | safe }}</p>

                      <div class="row mb-4">
                        <div class="col-md-6">
                          <div class="card border-primary">
                            <div class="card-header bg-primary text-white">Th·ªùi gian di·ªÖn ra</div>
                            <div class="card-body">
                              <p class="mb-0">{{ c.startDate }} ‚Üí {{ c.endDate }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="card border-info">
                            <div class="card-header bg-info text-white">Th·ªùi gian ƒëƒÉng k√Ω</div>
                            <div class="card-body">
                              <p class="mb-0">{{ c.registerStartDate }} ‚Üí {{ c.registerEndDate }}</p>
                            </div>
                          </div>
                        </div>
                      </div>

                      <h5>Tr·∫°ng th√°i:</h5>
                      <p>
                        {% if c.status == 1 %}ƒê√£ x√°c nh·∫≠n
                        {% elif c.status == 2 %}Ho·∫°t ƒë·ªông
                        {% elif c.status == 3 %}Th√†nh c√¥ng
                        {% elif c.status == 4 %}H·ªßy
                        {% elif c.status == 5 %}T·ª´ ch·ªëi
                        {% else %}Ch∆∞a x√°c ƒë·ªãnh{% endif %}
                      </p>

                      <h5>S·∫£n ph·∫©m tham gia chi·∫øn d·ªãch:</h5>
                      <table class="table table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>M√£ s·∫£n ph·∫©m</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>H√¨nh ·∫£nh</th>
                            <th>Gi√°</th>
                            <th>ƒê∆°n v·ªã</th>
                            <th>Hoa h·ªìng (%)</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for cp in campaign_products_map[c.id] %}
                          <tr>
                            <td>{{ cp.id }}</td>
                            <td>{{ cp.productBusinees.title }}</td>
                            <td>
                              {% if cp.productBusinees.image %}
                              <img src="{{ url_for('static', filename='uploads/' ~ cp.productBusinees.image) }}"
                                width="60" height="60" style="object-fit: cover;">
                              {% else %}
                              <span class="text-muted">Kh√¥ng c√≥ ·∫£nh</span>
                              {% endif %}
                            </td>
                            <td>{{ cp.productBusinees.amount }} VND</td>
                            <td>{{ cp.productBusinees.unitOfMeasure }}</td>
                            <td>{{ cp.commission * 100 }}%</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal fade" id="registerCampaignModal{{ c.id }}" tabindex="-1"
                aria-labelledby="registerCampaignModalLabel{{ c.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="registerCampaignModalLabel{{ c.id }}">ƒêƒÉng k√Ω chi·∫øn d·ªãch: {{ c.title
                        }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="POST" action="{{ url_for('home.register_campaign', campaign_id=c.id) }}">
                      <div class="modal-body">
                        <h5>Ch·ªçn s·∫£n ph·∫©m tham gia chi·∫øn d·ªãch:</h5>
                        <div class="mb-3">
                          <select name="product_ids" class="form-select" multiple required>
                            {% for cp in campaign_products_map[c.id] %}
                            <option value="{{ cp.id }}">{{ cp.productBusinees.title }} - {{ cp.productBusinees.amount }}
                              VND</option>
                            {% endfor %}
                          </select>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">ƒêƒÉng k√Ω</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Ph√¢n trang -->
      <nav>
        <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
      </nav>
    </div>
  </div>
</div>
<!-- Th√™m n√∫t "Xem chi ti·∫øt" trong danh s√°ch chi·∫øn d·ªãch -->
<!-- Duy·ªát qua t·ª´ng chi·∫øn d·ªãch -->

<style>
  .campaign-item {
    transition: all 0.3s ease-in-out;
  }

  .campaign-item.hide {
    display: none !important;
  }
</style>

<script>
  document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
    button.addEventListener('click', function () {
      var campaignId = this.getAttribute('data-bs-target').replace('#campaignDetailModal', '');
      console.log('M·ªü chi ti·∫øt chi·∫øn d·ªãch v·ªõi ID:', campaignId);
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    const checkboxes = document.querySelectorAll(".status-filter");
    const searchInput = document.getElementById("search-input");
    const sortSelect = document.getElementById("sort-select");
    const campaignList = document.getElementById("campaign-list");
    const noResult = document.getElementById("no-result");
    const pagination = document.getElementById("pagination");

    const pageSize = 6;
    let currentItems = [];

    function applyFilterAndSort() {
      const keyword = searchInput.value.trim().toLowerCase();
      const selectedStatuses = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      const sortOrder = sortSelect.value;

      // L·ªçc
      const allItems = Array.from(document.querySelectorAll(".campaign-item"));
      currentItems = allItems.filter(item => {
        const status = item.dataset.status;
        const title = item.dataset.title || "";
        const desc = item.dataset.description || "";
        return selectedStatuses.includes(status) && (title.includes(keyword) || desc.includes(keyword));
      });

      // S·∫Øp x·∫øp
      currentItems.sort((a, b) => {
        const dateA = new Date(a.dataset.date);
        const dateB = new Date(b.dataset.date);
        return sortOrder === "asc" ? dateA - dateB : dateB - dateA;
      });

      updatePagination();
    }

    function updatePagination() {
      const totalPages = Math.ceil(currentItems.length / pageSize);
      const currentPage = Math.min(getCurrentPage(), totalPages || 1);

      // ·∫®n t·∫•t c·∫£
      document.querySelectorAll(".campaign-item").forEach(el => el.classList.add("hide"));

      // Hi·ªÉn th·ªã c√°c item thu·ªôc trang hi·ªán t·∫°i
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      currentItems.slice(start, end).forEach(el => el.classList.remove("hide"));

      // Th√¥ng b√°o
      noResult.classList.toggle("d-none", currentItems.length > 0);

      // Ph√¢n trang
      renderPagination(totalPages, currentPage);
    }

    function renderPagination(totalPages, currentPage) {
      pagination.innerHTML = "";
      if (totalPages <= 1) return;

      const createPageItem = (page, text = page, active = false, disabled = false) => {
        const li = document.createElement("li");
        li.className = `page-item ${active ? "active" : ""} ${disabled ? "disabled" : ""}`;
        const a = document.createElement("a");
        a.className = "page-link";
        a.href = "#";
        a.textContent = text;
        a.addEventListener("click", (e) => {
          e.preventDefault();
          if (!disabled) {
            setCurrentPage(page);
            updatePagination();
          }
        });
        li.appendChild(a);
        return li;
      };

      pagination.appendChild(createPageItem(currentPage - 1, "¬´", false, currentPage === 1));

      for (let i = 1; i <= totalPages; i++) {
        pagination.appendChild(createPageItem(i, i, currentPage === i));
      }

      pagination.appendChild(createPageItem(currentPage + 1, "¬ª", false, currentPage === totalPages));
    }

    function setCurrentPage(page) {
      sessionStorage.setItem("campaignPage", page);
    }

    function getCurrentPage() {
      return parseInt(sessionStorage.getItem("campaignPage")) || 1;
    }

    // G·∫Øn s·ª± ki·ªán
    checkboxes.forEach(cb => cb.addEventListener("change", applyFilterAndSort));
    searchInput.addEventListener("input", applyFilterAndSort);
    sortSelect.addEventListener("change", applyFilterAndSort);

    applyFilterAndSort(); // ch·∫°y l·∫ßn ƒë·∫ßu
  });
  const currentDate = new Date().toISOString().split('T')[0];  // l·∫•y ng√†y hi·ªán t·∫°i
  console.log("Ng√†y hi·ªán t·∫°i: ", currentDate);
</script>
{% endblock %}