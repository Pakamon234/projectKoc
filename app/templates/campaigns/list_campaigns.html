{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">Danh m·ª•c chi·∫øn d·ªãch</h2>
  <div class="row">
    <!-- B·ªô l·ªçc tr√°i -->
    <div class="col-md-3">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title">L·ªçc theo tr·∫°ng th√°i</h5>

          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="1" id="check_1" checked>
            <label class="form-check-label text-warning" for="check_1">ƒê√£ x√°c nh·∫≠n</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="2" id="check_2" checked>
            <label class="form-check-label text-success" for="check_2">Ho·∫°t ƒë·ªông</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="3" id="check_3" checked>
            <label class="form-check-label text-primary" for="check_3">Th√†nh c√¥ng</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Danh s√°ch chi·∫øn d·ªãch -->
    <div class="col-md-9">
      <!-- T√¨m ki·∫øm & s·∫Øp x·∫øp -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="search-input" class="form-control me-3" placeholder="üîç T√¨m theo ti√™u ƒë·ªÅ ho·∫∑c m√¥ t·∫£..." style="max-width: 400px;">
        <select id="sort-select" class="form-select w-auto">
          <option value="desc">M·ªõi nh·∫•t tr∆∞·ªõc</option>
          <option value="asc">C≈© nh·∫•t tr∆∞·ªõc</option>
        </select>
      </div>

      <!-- Th√¥ng b√°o -->
      <div id="no-result" class="alert alert-info d-none text-center">
        <i class="fas fa-info-circle me-1"></i> Kh√¥ng t√¨m th·∫•y chi·∫øn d·ªãch ph√π h·ª£p.
      </div>

      <!-- Danh s√°ch + ph√¢n trang -->
      <div class="row row-cols-1 row-cols-md-2 g-4" id="campaign-list">
        {% for c in campaigns %}
        <div class="col campaign-item" data-status="{{ c.status }}" data-title="{{ c.title | lower }}" data-description="{{ c.description | lower }}" data-date="{{ c.startDate }}">
          <div class="card h-100 shadow-sm transition">
            <div class="card-body">
              <h5 class="card-title">{{ c.title }}</h5>
              <p class="card-text text-muted">{{ c.description[:100] }}{% if c.description|length > 100 %}...{% endif %}</p>
              <p class="card-text"><i class="fas fa-calendar-alt me-1"></i> T·ª´ {{ c.startDate }} ƒë·∫øn {{ c.endDate }}</p>

              <p class="card-text">
                {% if c.status == 1 %}
                  <span class="badge bg-warning text-dark">ƒê√£ x√°c nh·∫≠n</span>
                {% elif c.status == 2 %}
                  <span class="badge bg-success">Ho·∫°t ƒë·ªông</span>
                {% elif c.status == 3 %}
                  <span class="badge bg-primary">Th√†nh c√¥ng</span>
                {% endif %}
              </p>

              <a href="/campaign/{{ c.id }}" class="btn btn-outline-primary mt-2">Xem chi ti·∫øt</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Ph√¢n trang -->
      <nav>
        <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
      </nav>
    </div>
  </div>
</div>

<style>
.campaign-item {
  transition: all 0.3s ease-in-out;
}
.campaign-item.hide {
  display: none !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const checkboxes = document.querySelectorAll(".status-filter");
  const searchInput = document.getElementById("search-input");
  const sortSelect = document.getElementById("sort-select");
  const campaignList = document.getElementById("campaign-list");
  const noResult = document.getElementById("no-result");
  const pagination = document.getElementById("pagination");

  const pageSize = 6;
  let currentItems = [];

  function applyFilterAndSort() {
    const keyword = searchInput.value.trim().toLowerCase();
    const selectedStatuses = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    const sortOrder = sortSelect.value;

    // L·ªçc
    const allItems = Array.from(document.querySelectorAll(".campaign-item"));
    currentItems = allItems.filter(item => {
      const status = item.dataset.status;
      const title = item.dataset.title || "";
      const desc = item.dataset.description || "";
      return selectedStatuses.includes(status) && (title.includes(keyword) || desc.includes(keyword));
    });

    // S·∫Øp x·∫øp
    currentItems.sort((a, b) => {
      const dateA = new Date(a.dataset.date);
      const dateB = new Date(b.dataset.date);
      return sortOrder === "asc" ? dateA - dateB : dateB - dateA;
    });

    updatePagination();
  }

  function updatePagination() {
    const totalPages = Math.ceil(currentItems.length / pageSize);
    const currentPage = Math.min(getCurrentPage(), totalPages || 1);

    // ·∫®n t·∫•t c·∫£
    document.querySelectorAll(".campaign-item").forEach(el => el.classList.add("hide"));

    // Hi·ªÉn th·ªã c√°c item thu·ªôc trang hi·ªán t·∫°i
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    currentItems.slice(start, end).forEach(el => el.classList.remove("hide"));

    // Th√¥ng b√°o
    noResult.classList.toggle("d-none", currentItems.length > 0);

    // Ph√¢n trang
    renderPagination(totalPages, currentPage);
  }

  function renderPagination(totalPages, currentPage) {
    pagination.innerHTML = "";
    if (totalPages <= 1) return;

    const createPageItem = (page, text = page, active = false, disabled = false) => {
      const li = document.createElement("li");
      li.className = `page-item ${active ? "active" : ""} ${disabled ? "disabled" : ""}`;
      const a = document.createElement("a");
      a.className = "page-link";
      a.href = "#";
      a.textContent = text;
      a.addEventListener("click", (e) => {
        e.preventDefault();
        if (!disabled) {
          setCurrentPage(page);
          updatePagination();
        }
      });
      li.appendChild(a);
      return li;
    };

    pagination.appendChild(createPageItem(currentPage - 1, "¬´", false, currentPage === 1));

    for (let i = 1; i <= totalPages; i++) {
      pagination.appendChild(createPageItem(i, i, currentPage === i));
    }

    pagination.appendChild(createPageItem(currentPage + 1, "¬ª", false, currentPage === totalPages));
  }

  function setCurrentPage(page) {
    sessionStorage.setItem("campaignPage", page);
  }

  function getCurrentPage() {
    return parseInt(sessionStorage.getItem("campaignPage")) || 1;
  }

  // G·∫Øn s·ª± ki·ªán
  checkboxes.forEach(cb => cb.addEventListener("change", applyFilterAndSort));
  searchInput.addEventListener("input", applyFilterAndSort);
  sortSelect.addEventListener("change", applyFilterAndSort);

  applyFilterAndSort(); // ch·∫°y l·∫ßn ƒë·∫ßu
});
</script>
{% endblock %}
